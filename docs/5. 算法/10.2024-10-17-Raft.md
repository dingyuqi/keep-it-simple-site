---
title: 理解 Raft 算法：一致性和 Leader 选举机制详解
cover: /logo/Raft.svg
tags:
  - 分布式
  - 算法
createTime: 2024/10/17 15:14:49
permalink: /article/wr4ufchz/
---
在一个分布式系统中, 通常拥有许多节点. 节点之间如果需要达成共识, 确保节点之间的一致性成为了所有分布式系统都关注的问题.

Raft 是非常经典的一个分布式算法, 它可以保证一个分布式系统中所有节点都保持连续的一致性状态. Raft 算法旨在通过提供容错和确保选出单个领导者来协调操作所有节点. 本文中我们将深入研究 Raft 算法的核心概念, 重点在于节点的一致性和领导节点的选举.
<!-- more -->

## 什么是 Raft 算法?
Raft 算法最早是被斯坦福大学的 Diego Ongaro 和 John Ousterhout 提出的. 是为了能更好地理解之前的分布式一致性算法, 例如: Paxos 的同时提供更好的容错率以及领导者的选举能力.

::: note 快速连接
[Raft 论文](https://raft.github.io/raft.pdf)
:::

## 核心概念
::: note
为了不产生歧义并与论文对齐, 此处使用英文单词, 但是附上中文解释. 在后文中这些关键概念也使用英文.
:::

1. ***Node***: 节点. 在 Raft 中, 一个网络集群是由多个节点或者服务器组成的.
2. ***Leader***: 领导者. 在一个 Raft 集群中, 其中一个节点会被选为 Leader. Leader 会负责管理所有集群中节点的日志复制.
3. ***Follower***: 跟随者. 集群中所有除了 Leader 以外的节点都是 Follower. 它们会响应 Leader 的请求并向 Leader 转发客户端的请求.
4. ***Candidate***: 候选者. 当 Leader 宕机的时候, 集群需要选举出一个新的 Leader. 节点会将身份转变为 Candidate, 并开始竞选.
5. ***Term***: 任期. Raft 算法以 Term 为周期. 每个 Term 以一个选举开始并以下一个新 Leader 被选出或重新选举的时候为结束.
6. ***Log Replication***: 日志复制. Raft 算法会保证集群中所有的日志都被复制并且以相同的顺序保存.


## 一致性和 Leader 选举
Raft 算法的主要目标就是保证在集群中的节点之间达成关于系统状态的共识. 下面是它的工作原理:

1. **Leader 的选举**
::: steps
   1. 在每个任期的开始, 所有节点都是 Follower.
      
   2. 如果一个 Follower 在一个周期内没有收到 Leader 发送的任何信息(选举过期), 它会转变为 Candidate.
      
   3. Candidate 会请求其他节点投票给它. 如果它收到了半数以上的选票, 它将会成为 Leader.
      
   4. 如果没有任何一个 Node 成功收到超过半数的选票, 一个新的选举会在下一个 Term 展开.
:::

2. **日志复制和一致性**
::: steps
   1. Leader 接受客户端的请求并将其封装进 RPC.
      
   2. Leader 并发地将 RPC 请求发送给所有 Follower.
      
   3. 一旦超过半数的 Follower 确认了该请求, Leader 会回复客户端消息接收成功.
      
   4. 该请求会被追加写入日志并更新到状态机.
:::

## Raft 中的节点共识
Raft 达成共识的方法对于确保分布式系统的完整性和一致性至关重要.共识是通过一系列步骤达成的：

1. **日志复制**
   - 当客户端发起一个操作, 例如: 插入一个键值对, Leader 节点会收到请求.
   - Leader 将操作附加到其日志中, 并将此日志条目广播到集群中的所有其他节点.
   - 每个集群中的节点都会在自己的日志中追加写入这一条请求.

2. **大多数同意**
   - Raft 的运作原则是多数同意. 在向其状态机提交操作之前, Leader 会等待大多数节点的确认.

   - 如果大多数节点(例如 $\frac{N}{2} + 1$ 个)都在其日志中复制该操作, 即认为其确认该操作, 则 Leader 将该操作提交到其状态机

   - 这确保了操作正式成为系统状态的一部分, 并将在所有节点上一致地应用.

   此外, Leader 会定期向其他服务器发送更新以保持它们同步. 这确保了即使服务器掉队或崩溃, 它也可以快速赶上键值存储的最新状态.

## 与对等节点同步
与对等节点同步是 Raft 设计的一个关键方面, 它可以保持一致性并使新节点快速加入. 下面是它的工作原理：

1. **新服务器同步**
   - 当一个新的服务器加入 Raft 集群, 它需要迅速地与当前的键值对存储保持一致.
   - 为了完成这个目标, Leader 会向新服务器发送一系列日志信息, 确保它拥有完整的日志备份.
   - 这些日志会包含此前所有的数据操作.

2. **判断同步日志**
   - Leader 根据每个对等节点最后确认的日志索引确定为同步过程发送哪些日志.
   - 如果对端节点已经确认到索引 $k$ 的日志, 则 Leader 将从索引 $k + 1$ 开始发送到最后一个日志(n)进行同步.
   - 此过程确保新服务器接收它错过的所有操作, 并使其与键值存储的最新状态保持一致.

3. **处理同步错误**
   - 如果 Leader 不知道对等节点的最后一个已确认的日志索引, 它将使用试错法.
   - Leader 从其日志索引的末尾开始, 并根据对等节点的响应减少索引.
   - 如果对等节点在作为同步请求的一部分发送索引之前没有日志, 它将返回一个错误.

    这个迭代过程确保新服务器接收到用于同步的正确日志.

## Leader 选举
如果 Leader 发生故障, 对等节点将在设定的阈值内监视来自 Leader 的同步请求. 如果超过此阈值, 对等节点将认为 Leader 不可用, 并触发 Leader 选举. 它会向其他节点请求投票, 并在获得多数后宣布自己为新的 Leader. 

每个节点会 ==随机== 设置其阈值, 以防止同时选举. 这个阈值 ==必须超过同步间隔==, 以防止在 Leader 未宕机的情况下触发选举.


<br /><br /><br />

::: info 本文参考资料
1. [Understanding Raft Algorithm: Consensus and Leader Election Explained](https://medium.com/@jitenderkmr/understanding-raft-algorithm-consensus-and-leader-election-explained-faadf28fd047)
2. [The Raft Consensus Algorithm](https://raft.github.io/)
:::
